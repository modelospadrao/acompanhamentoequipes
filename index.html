<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acompanhamento de Equipes em Campo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      overscroll-behavior-y: none;
      overflow-x: hidden;
      height: 100vh;
    }

    body {
      font-family: Cambria, Cochin, Georgia, Times, sans-serif;
      background: #f5f5f5;
      padding: 10px;
    }

    h1 {
      text-align: center;
      color: #e63946;
      font-size: 24px;
      margin-bottom: 6px;
    }

    h2 {
      text-align: center;
      color: #000;
      font-size: 15px;
      margin-bottom: 15px;
    }

    /* BOT√ïES SALVAR/CARREGAR ESTADO */
    .estado-controles {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-estado {
      padding: 10px 20px;
      background: #ff9800;
      color: #fff;
      border: 2px solid #f57c00;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .btn-estado:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(0,0,0,0.3);
    }

    .btn-carregar-estado {
      background: #2196f3;
      border-color: #1976d2;
    }
    /* CONTROLE DE VISUALIZA√á√ÉO */
    .controle-visualizacao {
      text-align: center;
      margin-bottom: 12px;
      padding: 10px;
      background: #fff;
      border: 2px solid #000;
      border-radius: 6px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .controle-visualizacao h3 {
      margin-bottom: 8px;
      font-size: 14px;
    }

    .btn-visualizacao {
      padding: 8px 16px;
      margin: 3px;
      background: #fff;
      border: 2px solid #000;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    .btn-visualizacao:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    }

    .btn-visualizacao.active {
      background: #000;
      color: #fff;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }

    /* CONTAINER PRINCIPAL */
    .bases-container {
      max-width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* CADA BASE */
    .coluna {
      background: #fff;
      border: 2px solid #000;
      border-radius: 8px;
      padding: 12px;
      display: none;
    }

    .coluna.ativa {
      display: block;
    }

    /* CABE√áALHO - COMPACTO E ALINHADO */
    .coluna-header {
      background: #000;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: bold;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .header-row {
      display: grid;
      grid-template-columns: 100px 1fr;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .header-row:last-child {
      margin-bottom: 0;
    }

    .header-row label {
      font-size: 13px;
      font-weight: bold;
      text-align: left;
    }

    .header-row select {
      padding: 6px;
      border: none;
      border-radius: 3px;
      font-size: 13px;
      text-transform: uppercase;
      background: #fff;
    }

    /* BOT√ïES DE A√á√ÉO - COM SOMBRA */
    .acoes-grupo {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      justify-content: flex-start;
    }

    .btn-adicionar,
    .btn-remover {
      padding: 7px 14px;
      border: 1px solid #000;
      border-radius: 15px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      white-space: nowrap;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .btn-adicionar {
      background: #616964;
      color: #fff;
    }

    .btn-remover {
      background: #d32f2f;
      color: #fff;
    }

    .btn-adicionar:hover,
    .btn-remover:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.3);
    }

    /* FILTROS - COM SOMBRA */
    .filtros-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 12px;
      padding: 10px;
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    .filtros-container label {
      font-size: 13px;
      font-weight: bold;
      align-self: center;
    }

    .btn-filtro {
      background: #fff;
      border: 1px solid #2196f3;
      color: #2196f3;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    .btn-filtro.ativo {
      background: #2196f3;
      color: #fff;
      box-shadow: 0 3px 8px rgba(33, 150, 243, 0.4);
    }

    .btn-filtro:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    }

    /* CONTAINER DE EQUIPE - COM SOMBRA LATERAL */
    .equipe-container {
      margin-bottom: 10px;
      border-left: 4px solid #e63946;
      box-shadow: -3px 0 8px rgba(230, 57, 70, 0.2);
      border-radius: 5px;
    }

    /* LINHA DE EQUIPE - SEM COLUNA DF */
    .equipe-linha {
      display: grid;
      grid-template-columns: 1fr 2.5fr 0.6fr 0.6fr 0.6fr 1fr 0.8fr 0.5fr;
      gap: 6px;
      padding: 8px;
      background: #fff5f5;
      border: 2px solid #e63946;
      border-radius: 5px 5px 0 0;
      align-items: center;
      font-size: 11px;
    }

    /* BAIRROS EM LINHA HORIZONTAL */
    .bairros-container {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .bairro-item {
      flex: 1;
      min-width: 0;
    }

    .bairro-item select {
      width: 100%;
    }

    .bairros-controle {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .btn-add-bairro,
    .btn-rem-bairro {
      padding: 3px 6px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
      white-space: nowrap;
      min-width: 22px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }

    .btn-add-bairro {
      background: #4CAF50;
      color: #fff;
    }

    .btn-rem-bairro {
      background: #f44336;
      color: #fff;
    }

    .btn-add-bairro:hover,
    .btn-rem-bairro:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }

    .equipe-linha select,
    .equipe-linha input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 12px;
      text-transform: uppercase;
    }

    .equipe-linha input[type="number"] {
      text-align: center;
      padding: 4px 2px;
    }

    .equipe-linha input[readonly] {
      background: #e9e9e9;
    }

    .hora-grupo {
      display: flex;
      gap: 2px;
    }

    .hora-grupo input {
      flex: 1;
      font-size: 9px;
    }

    .btn-hora {
      padding: 4px 5px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 9px;
      white-space: nowrap;
    }

    .btn-hora:hover {
      background: #333;
    }

    /* BOT√ÉO DE OBSERVA√á√ÉO */
    .btn-obs {
      padding: 5px 8px;
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .btn-obs:hover {
      background: #1976d2;
    }

    .btn-obs.ativo {
      background: #ff9800;
    }

    /* CAMPO DE OBSERVA√á√ÉO - SOMBREADO */
    .obs-equipe {
      display: none;
      padding: 6px 8px;
      background: #ffd4d4;
      border: 2px solid #e63946;
      border-top: none;
      border-radius: 0 0 5px 5px;
    }

    .obs-equipe.visivel {
      display: block;
    }

    .obs-equipe textarea {
      width: 100%;
      min-height: 28px;
      max-height: 120px;
      padding: 5px;
      border: 1px solid #e63946;
      border-radius: 3px;
      font-size: 10px;
      font-family: inherit;
      resize: vertical;
      text-transform: uppercase;
      line-height: 1.2;
      background: #fff;
    }

    /* LABELS DOS CAMPOS */
    .labels-header {
      display: grid;
      grid-template-columns: 1fr 2.5fr 0.6fr 0.6fr 0.6fr 1fr 0.8fr 0.5fr;
      gap: 6px;
      padding: 6px 8px;
      background: #ddd;
      border-radius: 5px;
      margin-bottom: 8px;
      font-size: 11px;
      font-weight: bold;
      text-align: center;
    }

    /* √ÅREA DE PREVIEW - BOT√ïES COM SOMBRA */
    .preview-area {
      margin-top: 15px;
      border-top: 2px solid #000;
      padding-top: 10px;
    }

    .preview-area textarea {
      width: 100%;
      height: 250px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      background: #f9f9f9;
      resize: vertical;
    }

    .preview-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .btn-preview {
      padding: 10px 18px;
      border: 1px solid #000;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .btn-preview:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(0,0,0,0.3);
    }

    .btn-gerar {
      background: #4CAF50;
      color: #fff;
      border-color: #4CAF50;
    }

    .btn-copiar {
      background: #fff;
      color: #000;
    }

    .btn-pdf {
      background: #fff;
      border: 2px solid #000;
      color: #000;
    }

    .btn-whatsapp {
      background: #25d366;
      color: #fff;
      border-color: #25d366;
    }

    /* POPUP */
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 15px 30px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 9999;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* SCROLL */
    .equipes-scroll {
      max-height: 450px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .equipes-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .equipes-scroll::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .equipes-scroll::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }

    .equipes-scroll::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <h1>üöó ACOMPANHAMENTO DE EQUIPES EM CAMPO</h1>
  <h2>(Sistema de Controle por Base - Vers√£o 11.0 - Backup de Estado + UI Aprimorada)</h2>

  <!-- BOT√ïES SALVAR/CARREGAR ESTADO -->
  <div class="estado-controles">
    <button class="btn-estado" onclick="salvarEstado()">üíæ SALVAR ESTADO</button>
    <button class="btn-estado btn-carregar-estado" onclick="document.getElementById('fileInput').click()">üìÇ CARREGAR ESTADO</button>
    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="carregarEstado(event)">
  </div>

  <div class="controle-visualizacao">
    <h3>üìä Quantas bases acompanhar:</h3>
    <button class="btn-visualizacao active" onclick="mudarVisualizacao(1)">1 Base</button>
    <button class="btn-visualizacao" onclick="mudarVisualizacao(2)">2 Bases</button>
    <button class="btn-visualizacao" onclick="mudarVisualizacao(3)">3 Bases</button>
  </div>

  <div class="bases-container" id="container">
    <!-- BASE 1 -->
    <div class="coluna ativa" id="coluna1">
      <div class="coluna-header">
        <div class="header-row">
          <label>üè¢ BASE:</label>
          <select class="base-select">
            <option value="">-- SELECIONE --</option>
          </select>
        </div>
        <div class="header-row">
          <label>üë§ SUPERVISOR:</label>
          <select class="supervisor-select">
            <option value="">-- SELECIONE --</option>
          </select>
        </div>
        <div class="header-row">
          <label>üåç REGI√ÉO:</label>
          <select class="regiao-select" onchange="atualizarBairrosPorRegiao(1)">
            <option value="">-- SELECIONE --</option>
          </select>
        </div>
      </div>

      <div class="acoes-grupo">
        <button class="btn-adicionar" onclick="adicionarEquipe(1)">‚ûï Adicionar</button>
        <button class="btn-remover" onclick="removerEquipe(1)">‚ûñ Remover</button>
      </div>

      <div class="filtros-container">
        <label>üîç ORDENAR:</label>
        <button class="btn-filtro" onclick="ordenarEquipes(1, 'lead')">LEAD</button>
        <button class="btn-filtro" onclick="ordenarEquipes(1, 'bairro')">BAIRRO</button>
        <button class="btn-filtro" onclick="ordenarEquipes(1, 'original')">LIMPAR FILTROS</button>
      </div>

      <div class="labels-header">
        <div>LEAD</div>
        <div>BAIRRO(S)</div>
        <div>ENV</div>
        <div>EXE</div>
        <div>PEN</div>
        <div>TELEFONE</div>
        <div>HORA</div>
        <div>OBS</div>
      </div>

      <div class="equipes-scroll" id="equipes1"></div>

      <div class="preview-area">
        <div class="preview-buttons">
          <button class="btn-preview btn-gerar" onclick="gerarMensagem(1)">üìù Gerar</button>
          <button class="btn-preview btn-copiar" onclick="copiarMensagem(1)">üìã Copiar</button>
          <button class="btn-preview btn-whatsapp" onclick="enviarWhatsApp(1)">üì≤ WhatsApp</button>
          <button class="btn-preview btn-pdf" onclick="salvarPDF(1)">üíæ PDF</button>
        </div>
        <textarea id="preview1" readonly></textarea>
      </div>
    </div>

    <!-- BASE 2 -->
    <div class="coluna" id="coluna2">
      <div class="coluna-header">
        <div class="header-row">
          <label>üè¢ BASE:</label>
          <select class="base-select">
            <option value="">-- SELECIONE --</option>
          </select>
        </div>
        <div class="header-row">
          <label>üë§ SUPERVISOR:</label>
          <select class="supervisor-select">
            <option value="">-- SELECIONE --</option>
          </select>
        </div>
        <div class="header-row">
          <label>üåç REGI√ÉO:</label>
          <select class="regiao-select" onchange="atualizarBairrosPorRegiao(2)">
            <option value="">-- SELECIONE --</option>
          </select>
        </div>
      </div>

      <div class="acoes-grupo">
        <button class="btn-adicionar" onclick="adicionarEquipe(2)">‚ûï Adicionar</button>
        <button class="btn-remover" onclick="removerEquipe(2)">‚ûñ Remover</button>
      </div>

      <div class="filtros-container">
        <label>üîç ORDENAR:</label>
        <button class="btn-filtro" onclick="ordenarEquipes(2, 'lead')">LEAD</button>
        <button class="btn-filtro" onclick="ordenarEquipes(2, 'bairro')">BAIRRO</button>
        <button class="btn-filtro" onclick="ordenarEquipes(2, 'original')">LIMPAR FILTROS</button>
      </div>

      <div class="labels-header">
        <div>LEAD</div>
        <div>BAIRRO(S)</div>
        <div>ENV</div>
        <div>EXE</div>
        <div>PEN</div>
        <div>TELEFONE</div>
        <div>HORA</div>
        <div>OBS</div>
      </div>

      <div class="equipes-scroll" id="equipes2"></div>

      <div class="preview-area">
        <div class="preview-buttons">
          <button class="btn-preview btn-gerar" onclick="gerarMensagem(2)">üìù Gerar</button>
          <button class="btn-preview btn-copiar" onclick="copiarMensagem(2)">üìã Copiar</button>
          <button class="btn-preview btn-whatsapp" onclick="enviarWhatsApp(2)">üì≤ WhatsApp</button>
          <button class="btn-preview btn-pdf" onclick="salvarPDF(2)">üíæ PDF</button>
        </div>
        <textarea id="preview2" readonly></textarea>
      </div>
    </div>

    <!-- BASE 3 -->
    <div class="coluna" id="coluna3">
      <div class="coluna-header">
        <div class="header-row">
          <label>üè¢ BASE:</label>
          <select class="base-select">
            <option value="">-- SELECIONE --</option>
          </select>
        </div>
        <div class="header-row">
          <label>üë§ SUPERVISOR:</label>
          <select class="supervisor-select">
            <option value="">-- SELECIONE --</option>
          </select>
        </div>
        <div class="header-row">
          <label>üåç REGI√ÉO:</label>
          <select class="regiao-select" onchange="atualizarBairrosPorRegiao(3)">
            <option value="">-- SELECIONE --</option>
          </select>
        </div>
      </div>

      <div class="acoes-grupo">
        <button class="btn-adicionar" onclick="adicionarEquipe(3)">‚ûï Adicionar</button>
        <button class="btn-remover" onclick="removerEquipe(3)">‚ûñ Remover</button>
      </div>

      <div class="filtros-container">
        <label>üîç ORDENAR:</label>
        <button class="btn-filtro" onclick="ordenarEquipes(3, 'lead')">LEAD</button>
        <button class="btn-filtro" onclick="ordenarEquipes(3, 'bairro')">BAIRRO</button>
        <button class="btn-filtro" onclick="ordenarEquipes(3, 'original')">LIMPAR FILTROS</button>
      </div>

      <div class="labels-header">
        <div>LEAD</div>
        <div>BAIRRO(S)</div>
        <div>ENV</div>
        <div>EXE</div>
        <div>PEN</div>
        <div>TELEFONE</div>
        <div>HORA</div>
        <div>OBS</div>
      </div>

      <div class="equipes-scroll" id="equipes3"></div>

      <div class="preview-area">
        <div class="preview-buttons">
          <button class="btn-preview btn-gerar" onclick="gerarMensagem(3)">üìù Gerar</button>
          <button class="btn-preview btn-copiar" onclick="copiarMensagem(3)">üìã Copiar</button>
          <button class="btn-preview btn-whatsapp" onclick="enviarWhatsApp(3)">üì≤ WhatsApp</button>
          <button class="btn-preview btn-pdf" onclick="salvarPDF(3)">üíæ PDF</button>
        </div>
        <textarea id="preview3" readonly></textarea>
      </div>
    </div>
  </div>

  <div class="popup" id="popup"></div>

  <script>
    let dados = {
      bases: [],
      supervisores: [],
      leads: [],
      bairros: [],
      regioes: [],
      regiaoBairros: {}
    };

    let filtrosAtivos = {1: null, 2: null, 3: null};
    let contadores = {1: 0, 2: 0, 3: 0};

    async function carregarDados() {
      try {
        const [bases, supervisores, leads, bairros, regioes, regiaoBairros] = await Promise.all([
          fetch('./bases.json').then(r => r.json()).catch(() => []),
          fetch('./supervisores.json').then(r => r.json()).catch(() => []),
          fetch('./leads.json').then(r => r.json()).catch(() => []),
          fetch('./bairros.json').then(r => r.json()).catch(() => []),
          fetch('./regioes.json').then(r => r.json()).catch(() => []),
          fetch('./regiao-bairros.json').then(r => r.json()).catch(() => ({}))
        ]);

        dados.bases = bases.length ? bases : ['JACARECANGA', 'MARACANA√ö'];
        dados.supervisores = supervisores.length ? supervisores : ['FRANCISCO CLECIO', 'JEFERSON ALVES'];
        dados.leads = leads.length ? leads : ['DFJ-SG-01B', 'DFJ-SG-02C'];
        dados.bairros = bairros.length ? bairros : ['CENTRO', 'ALDEOTA'];
        dados.regioes = regioes.length ? regioes : ['DF-001', 'CASCAVEL'];
        dados.regiaoBairros = Object.keys(regiaoBairros).length ? regiaoBairros : {
          'DF-001': ['CENTRO', 'ALDEOTA'],
          'CASCAVEL': ['CASCAVEL CENTRO', 'CASCAVEL NORTE']
        };

        inicializarSelects();
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        dados = {
          bases: ['JACARECANGA', 'MARACANA√ö'],
          supervisores: ['FRANCISCO CLECIO', 'JEFERSON ALVES'],
          leads: ['DFJ-SG-01B', 'DFJ-SG-02C'],
          bairros: ['CENTRO', 'ALDEOTA'],
          regioes: ['DF-001', 'CASCAVEL'],
          regiaoBairros: {
            'DF-001': ['CENTRO', 'ALDEOTA'],
            'CASCAVEL': ['CASCAVEL CENTRO', 'CASCAVEL NORTE']
          }
        };
        inicializarSelects();
      }
    }

    function inicializarSelects() {
      document.querySelectorAll('.base-select').forEach(sel => {
        sel.innerHTML = '<option value="">-- SELECIONE --</option>';
        dados.bases.forEach(base => {
          sel.innerHTML += `<option value="${base}">${base}</option>`;
        });
      });

      document.querySelectorAll('.supervisor-select').forEach(sel => {
        sel.innerHTML = '<option value="">-- SELECIONE --</option>';
        dados.supervisores.forEach(sup => {
          sel.innerHTML += `<option value="${sup}">${sup}</option>`;
        });
      });

      document.querySelectorAll('.regiao-select').forEach(sel => {
        sel.innerHTML = '<option value="">-- SELECIONE --</option>';
        dados.regioes.forEach(regiao => {
          sel.innerHTML += `<option value="${regiao}">${regiao}</option>`;
        });
      });
    }

    window.onload = () => {
      carregarDados();
    };

    function mudarVisualizacao(num) {
      const colunas = document.querySelectorAll('.coluna');
      const botoes = document.querySelectorAll('.btn-visualizacao');

      botoes.forEach(b => b.classList.remove('active'));
      botoes[num - 1].classList.add('active');

      colunas.forEach(c => c.classList.remove('ativa'));

      for (let i = 1; i <= num; i++) {
        document.getElementById(`coluna${i}`).classList.add('ativa');
      }

      mostrarPopup(`üìä ${num} ${num === 1 ? 'Base' : 'Bases'}`);
    }

    function atualizarBairrosPorRegiao(col) {
      const coluna = document.getElementById(`coluna${col}`);
      const regiaoSelecionada = coluna.querySelector('.regiao-select').value;
      const equipesContainer = coluna.querySelector('.equipes-scroll');
      const bairrosSelects = equipesContainer.querySelectorAll('.bairro-select');

      // Atualiza TODOS os selects de bairro de TODAS as equipes
      bairrosSelects.forEach(sel => {
        const valorAtual = sel.value;
        sel.innerHTML = '<option value="">--</option>';

        if (regiaoSelecionada && dados.regiaoBairros[regiaoSelecionada]) {
          // Carrega s√≥ os bairros da regi√£o
          dados.regiaoBairros[regiaoSelecionada].forEach(b => {
            sel.innerHTML += `<option value="${b}">${b}</option>`;
          });
        } else {
          // Se n√£o tem regi√£o, mostra todos
          dados.bairros.forEach(b => {
            sel.innerHTML += `<option value="${b}">${b}</option>`;
          });
        }

        // Tenta manter o valor se ainda existir na nova lista
        if (valorAtual) {
          const temValor = Array.from(sel.options).some(opt => opt.value === valorAtual);
          if (temValor) {
            sel.value = valorAtual;
          }
        }
      });

      mostrarPopup(`üîÑ Regi√£o: ${regiaoSelecionada || 'TODOS'}`);
    }

    function toggleObservacao(btn) {
      const container = btn.closest('.equipe-container');
      const obsDiv = container.querySelector('.obs-equipe');
      const isVisible = obsDiv.classList.contains('visivel');

      obsDiv.classList.toggle('visivel');
      btn.classList.toggle('ativo');
      btn.textContent = isVisible ? 'üí¨' : '‚úñÔ∏è';
    }

    function adicionarBairro(btn) {
      const bairrosContainer = btn.closest('.bairros-container');
      const numBairros = bairrosContainer.querySelectorAll('.bairro-item').length;

      if (numBairros >= 3) {
        mostrarPopup('‚ö†Ô∏è M√°ximo 3 bairros!');
        return;
      }

      const coluna = btn.closest('.coluna');
      const regiaoSelecionada = coluna.querySelector('.regiao-select').value;

      let opcoesBairros = '';
      if (regiaoSelecionada && dados.regiaoBairros[regiaoSelecionada]) {
        opcoesBairros = dados.regiaoBairros[regiaoSelecionada].map(b => `<option value="${b}">${b}</option>`).join('');
      } else {
        opcoesBairros = dados.bairros.map(b => `<option value="${b}">${b}</option>`).join('');
      }

      const novoBairro = document.createElement('div');
      novoBairro.className = 'bairro-item';
      novoBairro.innerHTML = `
        <select class="bairro-select">
          <option value="">--</option>
          ${opcoesBairros}
        </select>
      `;

      bairrosContainer.insertBefore(novoBairro, bairrosContainer.querySelector('.bairros-controle'));
      mostrarPopup('‚úÖ Bairro!');
    }

    function removerBairro(btn) {
      const bairrosContainer = btn.closest('.bairros-container');
      const numBairros = bairrosContainer.querySelectorAll('.bairro-item').length;

      if (numBairros <= 1) {
        mostrarPopup('‚ö†Ô∏è M√≠nimo 1!');
        return;
      }

      const items = bairrosContainer.querySelectorAll('.bairro-item');
      items[items.length - 1].remove();
      mostrarPopup('‚ùå Removido!');
    }

    function ordenarEquipes(col, tipo) {
      const container = document.getElementById(`equipes${col}`);
      const equipesArray = Array.from(container.querySelectorAll('.equipe-container'));

      const coluna = document.getElementById(`coluna${col}`);
      coluna.querySelectorAll('.btn-filtro').forEach(b => b.classList.remove('ativo'));
      event.target.classList.add('ativo');

      filtrosAtivos[col] = tipo;

      if (tipo === 'original') {
        equipesArray.sort((a, b) => {
          return parseInt(a.dataset.ordem) - parseInt(b.dataset.ordem);
        });
      } else {
        equipesArray.sort((a, b) => {
          let valA, valB;

          if (tipo === 'lead') {
            valA = a.querySelector('.lead-select').value;
            valB = b.querySelector('.lead-select').value;
          } else if (tipo === 'bairro') {
            valA = a.querySelector('.bairro-select').value;
            valB = b.querySelector('.bairro-select').value;
          }

          return valA.localeCompare(valB);
        });
      }

      container.innerHTML = '';
      equipesArray.forEach(eq => container.appendChild(eq));

      gerarMensagem(col);
      mostrarPopup(`üîç ${tipo.toUpperCase()}`);
    }

    function adicionarEquipe(col) {
      const container = document.getElementById(`equipes${col}`);
      contadores[col]++;

      const coluna = document.getElementById(`coluna${col}`);
      const regiaoSelecionada = coluna.querySelector('.regiao-select').value;

      let opcoesBairros = '';
      if (regiaoSelecionada && dados.regiaoBairros[regiaoSelecionada]) {
        // Usa os bairros da regi√£o selecionada
        opcoesBairros = dados.regiaoBairros[regiaoSelecionada].map(b => `<option value="${b}">${b}</option>`).join('');
      } else {
        // Se n√£o tem regi√£o, mostra todos
        opcoesBairros = dados.bairros.map(b => `<option value="${b}">${b}</option>`).join('');
      }

      const equipeContainer = document.createElement('div');
      equipeContainer.className = 'equipe-container';
      equipeContainer.dataset.ordem = contadores[col];

      equipeContainer.innerHTML = `
        <div class="equipe-linha">
          <select class="lead-select">
            <option value="">--</option>
            ${dados.leads.map(l => `<option value="${l}">${l}</option>`).join('')}
          </select>

          <div class="bairros-container">
            <div class="bairro-item">
              <select class="bairro-select">
                <option value="">--</option>
                ${opcoesBairros}
              </select>
            </div>
            <div class="bairros-controle">
              <button class="btn-add-bairro" onclick="adicionarBairro(this)" title="Adicionar bairro">‚ûï</button>
              <button class="btn-rem-bairro" onclick="removerBairro(this)" title="Remover bairro">‚ûñ</button>
            </div>
          </div>

          <input type="number" class="enviados" min="0" max="99" placeholder="0" oninput="calcularPendentes(this)">

          <input type="number" class="executados" min="0" max="99" placeholder="0" oninput="calcularPendentes(this)">

          <input type="number" class="pendentes" readonly placeholder="0">

          <input type="text" class="telefone" maxlength="11" placeholder="85999999999" oninput="this.value=this.value.replace(/\\D/g,'')">

          <div class="hora-grupo">
            <input type="time" class="hora-apresentacao">
            <button class="btn-hora" onclick="capturarHora(this)">‚è∞</button>
          </div>

          <button class="btn-obs" onclick="toggleObservacao(this)">üí¨</button>
        </div>

        <div class="obs-equipe">
          <textarea class="obs-textarea" placeholder="OBSERVA√á√ÉO..." rows="1"></textarea>
        </div>
      `;

      container.appendChild(equipeContainer);
      mostrarPopup('‚úÖ Equipe!');
    }

    function removerEquipe(col) {
      const container = document.getElementById(`equipes${col}`);
      if (container.lastChild) {
        container.removeChild(container.lastChild);
        contadores[col]--;
        mostrarPopup('‚ùå Equipe removida!');
      }
    }

    function calcularPendentes(el) {
      const linha = el.closest('.equipe-linha');
      const env = parseInt(linha.querySelector('.enviados').value) || 0;
      const exe = parseInt(linha.querySelector('.executados').value) || 0;
      linha.querySelector('.pendentes').value = Math.max(0, env - exe);
    }

    function capturarHora(btn) {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      btn.previousElementSibling.value = `${h}:${m}`;
      mostrarPopup('‚è∞ Hor√°rio capturado!');
    }

    function gerarMensagem(col) {
      const coluna = document.getElementById(`coluna${col}`);
      const base = coluna.querySelector('.base-select').value;
      const supervisor = coluna.querySelector('.supervisor-select').value;
      const regiao = coluna.querySelector('.regiao-select').value;
      const equipes = coluna.querySelectorAll('.equipe-container');

      let msg = `---- *INFO. BASE* ----\n`;
      msg += `*BASE:* ${base || 'N√ÉO SELECIONADA'}\n`;
      msg += `*SUPERVISOR:* ${supervisor || 'N√ÉO SELECIONADO'}\n`;
      msg += `*REGI√ÉO:* ${regiao || 'N√ÉO SELECIONADA'}\n`;
      msg += `*TOTAL EQUIPES:* (${equipes.length})\n\n`;

      equipes.forEach((container, i) => {
        const linha = container.querySelector('.equipe-linha');
        const lead = linha.querySelector('.lead-select').value || 'N/A';

        const bairrosSelects = linha.querySelectorAll('.bairro-select');
        const bairros = Array.from(bairrosSelects)
          .map(s => s.value)
          .filter(v => v)
          .join(', ') || 'N/A';

        const env = linha.querySelector('.enviados').value || '0';
        const exe = linha.querySelector('.executados').value || '0';
        const pend = linha.querySelector('.pendentes').value || '0';
        const tel = linha.querySelector('.telefone').value || 'N√ÉO INFORMADO';
        const hora = linha.querySelector('.hora-apresentacao').value || 'N/A';
        const obs = container.querySelector('.obs-textarea').value.trim();

        msg += `---- *EQUIPE ${i + 1}* ----\n`;
        msg += `*LEAD:* ${lead}\n`;
        msg += `*BAIRRO(S):* ${bairros}\n`;
        msg += `*ENVIADOS:* ${env} | *EXEC:* ${exe} | *PEND:* ${pend}\n`;
        msg += `*TELEFONE:* ${tel}\n`;
        msg += `*HORA:* ${hora}\n`;
        if (obs) {
          msg += `*OBS:* ${obs}\n`;
        }
        msg += `\n`;
      });

      const now = new Date();
      msg += `üìÖ ${now.toLocaleDateString('pt-BR')} √†s ${now.toLocaleTimeString('pt-BR')}\n`;

      document.getElementById(`preview${col}`).value = msg;
    }

    function copiarMensagem(col) {
      const txt = document.getElementById(`preview${col}`);
      txt.select();
      document.execCommand('copy');
      mostrarPopup('üìã Copiado!');
    }

    function enviarWhatsApp(col) {
      const msg = document.getElementById(`preview${col}`).value;
      if (!msg.trim()) {
        mostrarPopup('‚ö†Ô∏è Gere a mensagem!');
        return;
      }
      const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
      mostrarPopup('üì≤ WhatsApp...');
    }

    function salvarPDF(col) {
      const coluna = document.getElementById(`coluna${col}`);
      const base = coluna.querySelector('.base-select').value || 'SEM_BASE';
      const now = new Date().toISOString().slice(0,10);

      html2pdf(coluna, {
        margin: 10,
        filename: `${base}_${now}_Base${col}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).then(() => mostrarPopup('üíæ PDF salvo!'));
    }

    function mostrarPopup(msg) {
      const popup = document.getElementById('popup');
      popup.textContent = msg;
      popup.style.display = 'block';
      setTimeout(() => popup.style.display = 'none', 2000);
    }

    // SALVAR ESTADO COMPLETO
    function salvarEstado() {
      const estado = {
        data: new Date().toISOString(),
        colunas: []
      };

      for (let col = 1; col <= 3; col++) {
        const coluna = document.getElementById(`coluna${col}`);
        if (!coluna.classList.contains('ativa')) continue;

        const colunaEstado = {
          base: coluna.querySelector('.base-select').value,
          supervisor: coluna.querySelector('.supervisor-select').value,
          regiao: coluna.querySelector('.regiao-select').value,
          equipes: []
        };

        const equipes = coluna.querySelectorAll('.equipe-container');
        equipes.forEach(eq => {
          const linha = eq.querySelector('.equipe-linha');
          const bairrosSelects = linha.querySelectorAll('.bairro-select');
          
          colunaEstado.equipes.push({
            lead: linha.querySelector('.lead-select').value,
            bairros: Array.from(bairrosSelects).map(s => s.value),
            enviados: linha.querySelector('.enviados').value,
            executados: linha.querySelector('.executados').value,
            telefone: linha.querySelector('.telefone').value,
            hora: linha.querySelector('.hora-apresentacao').value,
            observacao: eq.querySelector('.obs-textarea').value
          });
        });

        estado.colunas.push(colunaEstado);
      }

      const blob = new Blob([JSON.stringify(estado, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `estado_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      mostrarPopup('üíæ Estado salvo!');
    }

    // CARREGAR ESTADO
    function carregarEstado(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const estado = JSON.parse(e.target.result);
          
          // Limpa tudo primeiro
          for (let col = 1; col <= 3; col++) {
            const container = document.getElementById(`equipes${col}`);
            container.innerHTML = '';
            contadores[col] = 0;
          }

          // Restaura cada coluna
          estado.colunas.forEach((colEstado, idx) => {
            const col = idx + 1;
            const coluna = document.getElementById(`coluna${col}`);
            
            coluna.querySelector('.base-select').value = colEstado.base || '';
            coluna.querySelector('.supervisor-select').value = colEstado.supervisor || '';
            coluna.querySelector('.regiao-select').value = colEstado.regiao || '';

            // Restaura equipes
            colEstado.equipes.forEach(eqData => {
              adicionarEquipe(col);
              
              const container = document.getElementById(`equipes${col}`);
              const ultimaEquipe = container.lastChild;
              const linha = ultimaEquipe.querySelector('.equipe-linha');
              
              linha.querySelector('.lead-select').value = eqData.lead || '';
              
              // Restaura bairros
              const bairrosContainer = linha.querySelector('.bairros-container');
              eqData.bairros.forEach((bairro, bIdx) => {
                if (bIdx > 0) adicionarBairro(bairrosContainer.querySelector('.btn-add-bairro'));
              });
              
              const bairrosSelects = linha.querySelectorAll('.bairro-select');
              bairrosSelects.forEach((sel, bIdx) => {
                if (eqData.bairros[bIdx]) sel.value = eqData.bairros[bIdx];
              });
              
              linha.querySelector('.enviados').value = eqData.enviados || '';
              linha.querySelector('.executados').value = eqData.executados || '';
              linha.querySelector('.telefone').value = eqData.telefone || '';
              linha.querySelector('.hora-apresentacao').value = eqData.hora || '';
              ultimaEquipe.querySelector('.obs-textarea').value = eqData.observacao || '';
              
              calcularPendentes(linha.querySelector('.enviados'));
            });
          });

          mostrarPopup('üìÇ Estado carregado!');
          event.target.value = ''; // Limpa input
        } catch (error) {
          alert('‚ùå Erro ao carregar estado: ' + error.message);
        }
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>